# 使用支持ARM架构的Selenium镜像
# seleniarm/standalone-chromium支持ARM64架构
FROM seleniarm/standalone-chromium:latest

# 切换到root用户以安装软件包
USER root

# 安装Python和pip，以及构建依赖
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    python3-pip \
    python3-venv \
    python3-dev \
    build-essential \
    libxml2-dev \
    libxslt1-dev \
    gcc \
    tzdata \
    && rm -rf /var/lib/apt/lists/*

# 创建虚拟环境并激活
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# 升级pip和setuptools
RUN pip install --no-cache-dir --upgrade pip setuptools wheel

# 设置工作目录
WORKDIR /app

# 复制Python依赖文件
COPY requirements.txt ./

# 安装Python依赖（使用虚拟环境中的pip）
RUN pip install --no-cache-dir -r requirements.txt

# 复制整个应用代码
COPY . /app/

# 复制并设置新的启动脚本
COPY scripts/start_web.sh /app/start_web.sh
RUN chmod +x /app/start_web.sh

# 暴露Flask应用的端口
EXPOSE 5000

# 设置启动命令
CMD ["/app/start_web.sh"]
