# 使用官方的Selenium独立Chrome镜像作为基础
# 它已经包含了Chrome, VNC, 和noVNC
FROM selenium/standalone-chrome:latest

# 切换到root用户以安装软件包
USER root

# 安装Python和pip
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# 设置工作目录
WORKDIR /app

# 复制Python依赖文件
COPY requirements_web.txt ./

# 安装Python依赖
RUN pip3 install --no-cache-dir -r requirements_web.txt

# 复制整个应用代码
COPY . /app/

# 暴露Flask应用的端口
EXPOSE 5000

# 默认的Selenium镜像会启动VNC和浏览器
# 我们需要一个脚本来同时启动我们的Flask应用
# 创建一个新的启动脚本
RUN echo '#!/bin/bash
/opt/bin/entry_point.sh &
python3 /app/web_app.py
' > /app/start_app.sh && \
    chmod +x /app/start_app.sh

# 设置启动命令
CMD ["/app/start_app.sh"]
